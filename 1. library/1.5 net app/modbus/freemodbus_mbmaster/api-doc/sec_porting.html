<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EE MODBUS MASTER: Porting the MODBUS stack</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="dox.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">EE MODBUS MASTER
   &#160;<span id="projectnumber">v2022 (2022-12-23)</span>
   </div>
   <div id="projectbrief">portable C/C++ MODBUS stack</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('sec_porting.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Porting the MODBUS stack </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Porting the MODBUS stack is a necessary step for every platform. The basic procedure is as following </p><ol>
<li>
Create a new directory for your port from a skeleton. </li>
<li>
Implement the platform abstraction functions for enabling/disabling interrupts. </li>
<li>
Implement the timer functions. </li>
<li>
In case of RTU/ASCII you have to implement a serial abstraction layer. </li>
<li>
In case of TCP you have to implement the functions for handling TCP connections. </li>
<li>
In case you have an RTOS you can implement an event queue for better performance. </li>
</ol>
<p>We start by creating a new directory <code>demo/PLATFORM</code>. In the next step the necessary files from the directory <code>demo/BARE</code> should be copied into this directory following the directory structure from below.</p>
<pre class="fragment">demo/PLATFORM/mbmdemo-ser.c (If you use the MODBUS master and RTU/ASCII)
demo/PLATFORM/mbmdemo-tcp.c (If you use the MODBUS master and TCP)
demo/PLATFORM/port/mbport.h
demo/PLATFORM/port/mbmconfig.h (If you use the MODBUS master stack)
demo/PLATFORM/port/mbsconfig.h (If you use the MODBUS slave stack)
demo/PLATFORM/port/mbportevent.c
demo/PLATFORM/port/mbportother.c
demo/PLATFORM/port/mbporttimer.c
demo/platform/port/mbportserial.c (If you use RTU/ASCII)
demo/platform/port/mbporttcp.c (If you use RTU/ASCII)
</pre><h1><a class="anchor" id="sec_porting_build"></a>
Build system</h1>
<p>We do not provide any additional information for the build process but the following settings work fine. </p><ul>
<li>
The preprocessor include directories should at least the path <code>mbmaster/include</code> or <code>mbslave/include</code> and <code>demo/PLATFORM/port</code>. </li>
<li>
It is recommend to create your project file in the <code>demo/PLATFORM</code> directory. </li>
<li>
You can to include all the relevant C files from the <code>mbslave</code> and <code>mbmaster</code> subdirectory into your build process. </li>
</ul>
<h1><a class="anchor" id="sec_porting_ospecific"></a>
Platform specifics (mbport.h)</h1>
<p>You should verify the file <code>mbport.h</code> if the data types matches you platform. You can also place additional include files at the top of this file. This file is included by every module of the MODBUS stack.</p>
<h1><a class="anchor" id="sec_porting_timers"></a>
Implementation of timers (mbporttimer.c)</h1>
<p>The MODBUS stack needs timer to detect the end of frame or to signal errors to the use when a slave (or master) does not respond. An example implementation is already provided in <code>mbporttimer.c</code> which needs only very little customization. The only thing which has to be added is the actual initialization of the timer in the function eMBPTimerInit. In addition the prototype for the ISR handler prvvTimerISR should be checked for compiler specifics. The timer itself should be initialized as following: </p><ul>
<li>
A periodic timer with a period of approx. 1ms </li>
<li>
A interrupt associated with the timer overflow which calls the interrupt handler prvvTimerISR. </li>
</ul>
<h1><a class="anchor" id="sec_porting_serial"></a>
Implementation of serial functions (mbportserial.c)</h1>
<p>For RTU/ASCII you need to implement serial communication functions. An example is already provided in <code>mbportserial.c</code>. The things which need to be added are: </p><ul>
<li>
Create the real initialization code in the function eMBPSerialInit. </li>
<li>
Create the shutdown code in eMBPSerialClose if you need it. </li>
<li>
Implement enabling/disabling of the transmitter in eMBPSerialTxEnable. </li>
<li>
Implement enabling/disabling of the receiver in eMBPSerialRxEnable. </li>
<li>
Adapt or change the interrupt functions prrvUSARTTxISR and prrvUSARTRxISR. </li>
</ul>
<h1><a class="anchor" id="sec_porting_event"></a>
Event queue (mbportevent.c)</h1>
<p>The skeleton is already provided but in case of an RTOS the functions should use a real event queue. You can take a look at the provided Linux ports for an example on how to do this.</p>
<h1><a class="anchor" id="sec_porting_customize"></a>
Customizing the stack</h1>
<p>You can enable or disable most functions from the stack. Default values are provided in the file <code>mbmaster/include/mbmiconfig.h</code> or <code>/mbslave/include/mbiconfig.h</code>. If you want to override any of these settings simply add them to your project local <code>mbmconfig.h</code> and <code>mbsconfig.h</code> file. Do not change any files within the MODBUS stack. You can find a detailed description of these options in this doxygen configuration. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
