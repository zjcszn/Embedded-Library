<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QP/C: State Machines</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="ql-preview.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="ql-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
  <div id="projectlogo">
    <a href="https://www.state-machine.com" title="Quantum Leaps"><img alt="Logo" src="logo_ql.png"/></a>
  </div>
   <div id="projectname">
    QP/C
    &nbsp;<span id="projectnumber">7.3.4</span>
   </div>
   <div id="projectbrief">Real-Time Embedded Framework</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;"
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('sds_sm.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">State Machines</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><span class="prev_button"><a class="el" href="sds.html#sds_scope">Purpose and Scope</a></span> </p>
<div style="clear:both;"></div><p> The behavior of each active object in QP Framework is specified by means of a <a href="https://www.state-machine.com/fsm/#HSM" class="extern" target="_blank">hierarchical state machine</a> (UML statechart), which is the most effective and elegant technique of describing event-driven behavior. The most important innovation of UML state machines over classical finite state machines (FSMs) is the hierarchical state nesting. The value of state nesting lies in avoiding repetitions, which are inevitable in the traditional "flat" FSM formalism and are the main reason for the "state-transition explosion" in FSMs. The semantics of state nesting allow substates to define only the differences of behavior from the superstates, thus promoting sharing and reusing behavior.</p>
<p>The Quantum Leaps Application Note <a href="https://www.state-machine.com/doc/AN_Crash_Course_in_UML_State_Machines.pdf" class="extern" target="_blank"><b>A Crash Course in UML State Machines</b></a> introduces the main state machine concepts backed up by examples.</p>
<dl class="section note"><dt>Note</dt><dd>The hallmark of the QP Framework implementation of UML state machines is <b>traceability</b>, which is direct, precise, and unambiguous mapping of every state machine element to human-readable, portable code. Preserving the traceability from requirements through design to code is essential for mission-critical systems, such as medical devices or avionic systems.</dd></dl>
<p>This section describes how to implement <a href="https://www.state-machine.com/fsm/#HSM" class="extern">hierarchical state machines</a> with the QP&trade;/C real-time embedded framework, which is quite a mechanical process consisting of just a few simple rules. (In fact, the process of coding state machines in QP&trade;/C has been automated by the QM model-based design and code-generating tool.)</p>
<p>To focus this discussion, this section uses the Calculator example, located in the directory <span class="img folder">qpcpp/examples/workstation/calc</span>. This example has been used in the <a href="https://www.state-machine.com/psicc2" class="extern">PSiCC2 book</a> (Section 4.6 "Summary of Steps for Implementing HSMs with QEP")</p>
<p>This section explains how to code the following (marked) elements of a hierarchical state machine:</p>
<div class="image">
<img src="sds_calc.png" alt=""/>
<div class="caption">
Fragment of the Calculator hierarchical state machine</div></div>
 <p><code>[1]</code> The top-most initial pseudo-state</p>
<p><code>[2]</code> A state (nested in the implicit <code>top</code> state)</p>
<p><code>[3]</code> An entry action to a state</p>
<p><code>[4]</code> An exit action from a state</p>
<p><code>[5]</code> An initial transition nested in a state</p>
<p><code>[6]</code> A regular state transition</p>
<p><code>[7]</code> A state (substate) nested in another state (superstate)</p>
<p><code>[8]</code> Even more deeply nested substate</p>
<p><code>[9]</code> A choice point with a guard</p>
<dl class="section note"><dt>Note</dt><dd>This section describes the <a class="el" href="srs_sm.html#srs_sm-impl">QHsm state machine implementation strategy</a>, suitable for <b>manual coding</b> of hierarchical state machines in QP&trade;/C. The alternative <a class="el" href="srs_sm.html#srs_sm-impl">QMsm state machine implementation strategy</a>, which QP&trade;/C also supports, is not covered in this section, as the code needs to be generated automatically by the <a href="https://www.state-machine.com/products/qm" class="extern" target="_blank">QM modeling tool</a>.</dd></dl>
<h1><a class="anchor" id="sm_decl"></a>
State Machine Declaration</h1>
<p>Hierarchical state machines are represented in QP&trade;/C as subclasses of the <a class="el" href="sas_core.html#ARC-QP-02_20">QHsm abstract base class</a>, which is defined in the header file <span class="img folder">qpc\include\qep.h</span>. Please note that abstract classes like <a class="el" href="struct_q_msm.html" title="Hierarchical State Machine class (QMsm-style state machine implementation strategy)">QMsm</a>, <a class="el" href="struct_q_active.html" title="Active object class (based on the QHsm implementation strategy)">QActive</a> and <a class="el" href="struct_q_m_active.html" title="Active object class (based on QMsm implementation strategy)">QMActive</a> are also subclasses of <a class="el" href="struct_q_hsm.html" title="Hierarchical State Machine class (QHsm-style state machine implementation strategy)">QHsm</a>, so their subclasses also can have state machines.</p>
<div class="fragment"><div class="line">    <span class="keyword">struct </span>Calc {</div>
<div class="line">    <span class="comment">/* protected */</span></div>
<div class="line">[1]    <a class="code hl_class" href="struct_q_hsm.html">QHsm</a> super; <span class="comment">/* inherit QHsm */</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* private: */</span></div>
<div class="line">[2]    <span class="keywordtype">double</span> m_operand1;</div>
<div class="line">       uint8_t m_operator;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* public: */</span></div>
<div class="line">[3] Calc_ctor(Calc * <span class="keyword">const</span> me) { <span class="comment">/* constructor */</span></div>
<div class="line">[4]     QHsm_ctor(&amp;me-&gt;super, &amp;Calc_initial) <span class="comment">/* superclass&#39; constructor */</span></div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* protected: */</span></div>
<div class="line">[5] <a class="code hl_typedef" href="qp_8h.html#aca8402343f1e6379e68bc32d471c3ff1">QState</a> Calc_initial(Calc * <span class="keyword">const</span> me, <span class="keywordtype">void</span> <span class="keyword">const</span> * <span class="keyword">const</span> par);</div>
<div class="line">[6] <a class="code hl_typedef" href="qp_8h.html#aca8402343f1e6379e68bc32d471c3ff1">QState</a> Calc_on(Calc * <span class="keyword">const</span> me, <a class="code hl_class" href="struct_q_evt.html">QEvt</a> <span class="keyword">const</span> * <span class="keyword">const</span> e);</div>
<div class="line">    <a class="code hl_typedef" href="qp_8h.html#aca8402343f1e6379e68bc32d471c3ff1">QState</a> Calc_ready(Calc * <span class="keyword">const</span> me, <a class="code hl_class" href="struct_q_evt.html">QEvt</a> <span class="keyword">const</span> * <span class="keyword">const</span> e);</div>
<div class="line">    <a class="code hl_typedef" href="qp_8h.html#aca8402343f1e6379e68bc32d471c3ff1">QState</a> Calc_result(Calc * <span class="keyword">const</span> me, <a class="code hl_class" href="struct_q_evt.html">QEvt</a> <span class="keyword">const</span> * <span class="keyword">const</span> e);</div>
<div class="line">    <a class="code hl_typedef" href="qp_8h.html#aca8402343f1e6379e68bc32d471c3ff1">QState</a> Calc_begin(Calc * <span class="keyword">const</span> me, <a class="code hl_class" href="struct_q_evt.html">QEvt</a> <span class="keyword">const</span> * <span class="keyword">const</span> e);</div>
<div class="line">        . . .</div>
<div class="ttc" id="aqp_8h_html_aca8402343f1e6379e68bc32d471c3ff1"><div class="ttname"><a href="qp_8h.html#aca8402343f1e6379e68bc32d471c3ff1">QState</a></div><div class="ttdeci">enum QStateRet QState</div><div class="ttdef"><b>Definition</b> <a href="qp_8h_source.html#l00223">qp.h:223</a></div></div>
<div class="ttc" id="astruct_q_evt_html"><div class="ttname"><a href="struct_q_evt.html">QEvt</a></div><div class="ttdoc">Event class.</div><div class="ttdef"><b>Definition</b> <a href="qp_8h_source.html#l00147">qp.h:147</a></div></div>
<div class="ttc" id="astruct_q_hsm_html"><div class="ttname"><a href="struct_q_hsm.html">QHsm</a></div><div class="ttdoc">Hierarchical State Machine class (QHsm-style state machine implementation strategy)</div><div class="ttdef"><b>Definition</b> <a href="qp_8h_source.html#l00313">qp.h:313</a></div></div>
</div><!-- fragment --><p><code>[1]</code> Class <code>Calc</code> (Calculator) derives from <a class="el" href="struct_q_hsm.html" title="Hierarchical State Machine class (QHsm-style state machine implementation strategy)">QHsm</a>, so it can have a state machine</p>
<p><code>[2]</code> The class can have data members (typically private), which will be accessible inside the state machine as the "extended-state variables".</p>
<p><a class="anchor" id="sm_ctor"></a><code>[3]</code> The class needs to provide a <b>constructor</b>, typically without any parameters.</p>
<p><code>[4]</code> The constructor must call the appropriate superclass' constructor. The superclass' constructor takes the top-most a pointer to the <code>Calc_initial</code> pseudo-state (see step [5]), which binds the state-machine to the class.</p>
<p><code>[5]</code> Each state machine must have exactly one initial pseudo-state, which by convention should be always called <b>initial</b>. The initial pseudo-state is declared with the shown parameter list.</p>
<p><code>[6]</code> All other state handlers are declared with the shown signature.</p>
<h1><a class="anchor" id="sm_def"></a>
State Machine Definition</h1>
<p>The definition of the state machine class is the actual code for your state machine. You need to define (i.e., write the code for) all "state-handler" member functions you declared in the <a class="el" href="sds_sm.html#sm_decl">state machine class declaration</a>.</p>
<p>One important aspect to realize about coding "state-handler" functions is that they are always called during the process of <a class="el" href="srs_sm.html#srs_sm-dispatch">dispatching events</a>. The purpose of the "state-handlers" is to perform <em>your</em> specific actions and then to <em>tell</em> the event processor what needs to be done with the state machine. For example, if your "state-handler" performs a state transition, it executes some actions and then it calls the special <code>QHsm_tran_(&lt;target&gt;)</code> function, where it specifies the <code>&lt;target&gt;</code> state of this state transition. The state-handler then <b>returns</b> the status from the <code>tran()</code> function, and through this return value it informs the <a class="el" href="srs_sm.html#srs_sm-dispatch">dispatch operation</a> what needs to be done with the state machine. Based on this information, the event-processor might decide to call this or other state-handler functions to process the same current event. The following code examples should make all this clearer.</p>
<p><span class="prev_button"><a class="el" href="sds.html#sds_scope">Purpose and Scope</a></span>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="sds.html">Software Design Specification</a></li>
    <li class="footer">
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2024 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QP/C 7.3.4</b> &nbsp;|&nbsp; Updated on Thu Mar 21 2024
<hr class="footer"/><address class="footer"><small>
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2024 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QP/C 7.3.4</b> &nbsp;|&nbsp; Updated on Thu Mar 21 2024
</small></address>
    </li>
  </ul>
</div>
</body>
</html>
